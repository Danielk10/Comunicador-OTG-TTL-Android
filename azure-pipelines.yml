trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'GH_TOKEN'
- name: repoUrl
  value: 'github.com/Danielk10/Comunicador-OTG-TTL-Android.git'

steps:
- checkout: self
  persistCredentials: true
  fetchDepth: 0

# 1. Compilar APK y AAB en modo Debug
- task: Gradle@3
  displayName: 'Build APK & AAB Debug'
  inputs:
    gradleWrapperFile: 'gradlew'
    tasks: 'assembleDebug bundleDebug'
    publishJUnitResults: false
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.21'

# 2. Colectar archivos generados
- task: CopyFiles@2
  displayName: 'Colectar archivos para Azure'
  inputs:
    Contents: |
      **/*-debug.apk
      **/*-debug.aab
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true

# 3. Publicar en Azure Artifacts
- task: PublishBuildArtifacts@1
  displayName: 'Publicar Artefactos en Azure'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Android_Debug_Builds'
    publishLocation: 'Container'

# 4. Sincronizar con GitHub (Danielk10)
- script: |
    # ConfiguraciÃ³n de identidad
    git config --global user.email "danielpdiamon@gmail.com"
    git config --global user.name "Danielk10"
    
    # Reconfigurar remoto con token
    git remote set-url origin "https://$(GH_TOKEN)@$(repoUrl)"
    
    # A) PRIMERO preparamos nuestros cambios locales (incluyendo gradlew)
    # Corregido el echo para evitar el error 'command not found'
    echo "Build ID: $(Build.BuildId) - Hecho el: $(Build.QueuedAt)" > build_info.txt
    git add .
    git commit -m "Automated update build $(Build.BuildId) [skip ci]"
    
    # B) SEGUNDO traemos lo nuevo de GitHub y ponemos nuestro commit encima
    # Esto soluciona el error 'rejected (fetch first)'
    git pull origin main --rebase
    
    # C) TERCERO subimos todo a GitHub
    git push origin HEAD:main
  displayName: 'Enviar cambios a GitHub'
  env:
    GH_TOKEN: $(GH_TOKEN)