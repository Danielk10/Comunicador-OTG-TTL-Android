trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

# 1. Configuración de Variables (Vínculo con el Grupo GH_TOKEN)
variables:
- group: 'GH_TOKEN' # Nombre de tu grupo en la Library
- name: repoUrl
  value: 'github.com/Danielk10/Comunicador-OTG-TTL-Android.git'

steps:
- checkout: self
  persistCredentials: true
  fetchDepth: 0 # Necesario para que Git tenga el historial para el push

# 2. Construcción de APK y AAB (Modo Debug sin firmar)
- task: Gradle@3
  displayName: 'Compilar APK y AAB Debug'
  inputs:
    gradleWrapperFile: 'gradlew'
    tasks: 'assembleDebug bundleDebug'
    publishJUnitResults: false
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.21' # Recomendado para Gradle 9.3.x

# 3. Colectar Archivos Generados
- task: CopyFiles@2
  displayName: 'Colectar archivos para Azure'
  inputs:
    Contents: |
      **/*-debug.apk
      **/*-debug.aab
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true

# 4. Guardar archivos en la sección Artifacts de Azure
- task: PublishBuildArtifacts@1
  displayName: 'Publicar Artefactos en Azure'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Android_Debug_Builds'
    publishLocation: 'Container'

# 5. Sincronizar cambios de vuelta a GitHub
- script: |
    # Configuración de identidad de Git
    git config --global user.email "daniel.elias.diamon@gmail.com"
    git config --global user.name "Daniel Elias Diamon"
    
    # Reconfigurar el remoto usando el token del grupo de variables
    # Se asume que la variable dentro del grupo también se llama GH_TOKEN
    git remote set-url origin https://$(GH_TOKEN)@$(repoUrl)
    
    # Añadir un archivo de registro del build
    echo "Last build: $(Build.BuildId) - Date: $(Build.QueuedAt)" > build_status.txt
    git add .
    
    # [skip ci] evita que este commit dispare otro build infinito
    git commit -m "Automated update build $(Build.BuildId) [skip ci]"
    git push origin HEAD:main
  displayName: 'Enviar cambios a GitHub'
  env:
    GH_TOKEN: $(GH_TOKEN) # Mapeo obligatorio de la variable del grupo al entorno