trigger:
- main  # Escucha cambios externos en la rama main

pool:
  vmImage: 'ubuntu-latest'

variables:
  repoUrl: 'github.com/Danielk10/Comunicador-OTG-TTL-Android.git'

steps:
- checkout: self
  persistCredentials: true
  fetchDepth: 0

- task: Gradle@3
  displayName: 'Build APK & AAB Debug'
  inputs:
    gradleWrapperFile: 'gradlew'
    tasks: 'assembleDebug bundleDebug'
    publishJUnitResults: false

- task: CopyFiles@2
  displayName: 'Colectar Archivos'
  inputs:
    Contents: |
      **/*-debug.apk
      **/*-debug.aab
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true

- task: PublishBuildArtifacts@1
  displayName: 'Publicar en Azure'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'Android_Builds'

- script: |
    git config --global user.email "tu-email@ejemplo.com"
    git config --global user.name "Daniel Elias"
    git remote set-url origin https://$(GH_TOKEN)@$(repoUrl)
    git add .
    git commit -m "Build autom√°tico $(Build.BuildId) [skip ci]"
    git push origin HEAD:main
  displayName: 'Sincronizar con GitHub'
  env:
    GH_TOKEN: $(GH_TOKEN)